define("modules/clean/unity/check_file_cache",["modules/clean/unity/features"],function(e){if(null!=e)return(function(){function n(){}return n._cache={},n.is_cached_and_locally_available=function(n,t){var _;return _=this._cache[e.server_path(n,t)],null!=_&&_.is_locally_available},n.get=function(n,t){return this._cache[e.server_path(n,t)]},n.set=function(e,n){return this._cache[e]=n},n.set_batch=function(e){var n,t,_;t=[];for(_ in e)n=e[_],t.push(this._cache[_]=n);return t},n.clear=function(){return this._cache={}},n})()});var bind=function(e,n){return function(){return e.apply(n,arguments)}},indexOf=[].indexOf||function(e){for(var n=0,t=this.length;n<t;n++)if(n in this&&this[n]===e)return n;return-1};define("modules/clean/unity/connection",["jquery","modules/core/exception","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/connection_error","modules/clean/unity/logger","modules/clean/unity/versions","modules/clean/unity/web_socket","modules/clean/viewer"],function(e,n,t,_,i,s,r,o,a,u){if(a.web_sockets_supported())return(function(){function c(){this._on_response_timeout=bind(this._on_response_timeout,this),this._on_message=bind(this._on_message,this),this._set_connection_state=bind(this._set_connection_state,this),this._on_error=bind(this._on_error,this),this._on_close=bind(this._on_close,this),i.getGandalfRule("unity-web-debug")&&(window.uc=this),this.client_version=null,this._on_open_callbacks=[],this._on_open_failed_callbacks=[],this._on_close_callbacks=[],this._pending_callbacks=[],this._response_callbacks={},this._ws=null,this._port=null,this._active_ports={},this._connection_state=c._CONNECTION_PENDING,this._current_message_id=1,this._permission_level=null,this.logger=new r,this._routes={check_unity_version:this._check_unity_version.bind(this),fetch_unity_nonce:this._fetch_unity_nonce.bind(this),complete_handshake:this._complete_handshake.bind(this)}}return c._CONNECTION_OPENED_STATE=0,c._VERSION_CHECK_STATE=1,c._FETCHING_NONCE_STATE=2,c._NONCE_RETURNED_TO_CLIENT_STATE=3,c._HANDSHAKE_COMPLETED_STATE=4,c._CONNECTION_PENDING=0,c._CONNECTION_ESTABLISHED=1,c._CONNECTION_CLOSED=2,c._CONNECTION_RETRYING=3,c._RESPONSE_TIMEOUT=5e3,c._MIN_PORT=17600,c._MAX_PORT=17602,c.SECURE_PERMISSION="secure",c.INSECURE_WEB_PERMISSION="insecure_web",c.INSECURE_CLIENT_PERMISSION="insecure_client",c.INSECURE_PERMISSION="insecure",c.prototype.start=function(){return a.load_flash_policy_if_needed()?this._attempt_handshake():void this._set_connection_state(c._CONNECTION_CLOSED)},c.prototype._attempt_handshake=function(){var e,n,_,i,s,r,o;try{for(_=n=i=c._MIN_PORT,s=c._MAX_PORT;i<=s?n<=s:n>=s;_=i<=s?++n:--n)this._active_ports[_]=!0,r={scheme:"ws",authority:"127.0.0.1:"+_.toString(),path:"/ws"},o=a.create(t(r).toString()),o.onmessage=this._on_message({ws:o,port:_,state:c._CONNECTION_OPENED_STATE,client_version:null,client_has_auth:null}),o.onclose=this._on_close(_),o.onerror=this._on_error(_)}catch(n){e=n,this.logger.report_event("unity_failure",{message:"WebSocket creation failed. Message: "+e.message,error_name:e.name,port:_}),this._set_connection_state(c._CONNECTION_CLOSED)}return this.logger.report_event("handshake_started")},c.prototype._on_close=function(e){return(function(n){return function(t){var _;return 1e3===(_=t.code)||1001===_||1005===_||1006===_||n.logger.report_event("unity_failure",{message:"WebSocket closed. Code: "+t.code+". Reason: "+t.reason,port:e}),n._close_port(e)}})(this)},c.prototype._on_error=function(e){return(function(n){return function(t){return n.logger.report_event("unity_failure",{message:"WebSocket error. Message: "+t.data,port:e}),n._close_port(e)}})(this)},c.prototype._close_port=function(n){if(n in this._active_ports&&(delete this._active_ports[n],e.isEmptyObject(this._active_ports)))return this._connection_state===c._CONNECTION_ESTABLISHED?this._retry_connection():this._set_connection_state(c._CONNECTION_CLOSED)},c.prototype._retry_connection=function(){return this.logger.report_event("connection_retrying"),this._set_connection_state(c._CONNECTION_RETRYING),this.client_version=this._ws=this._port=null,this._attempt_handshake()},c.prototype._set_connection_state=function(e){var t,_,i,r,o,a,u,l,h,d,f,p,E,N,g,O;if(e!==this._connection_state){if(h=this._connection_state,n.assert(h!==c._CONNECTION_CLOSED,"Shouldn't unclose a closed connection."),this._connection_state=e,e===c._CONNECTION_ESTABLISHED){if(n.assert(this._is_connection_in_progress(h),"Can only establish from pending or retrying."),this.logger.report_event("handshake_complete"),h===c._CONNECTION_PENDING)for(d=this._on_open_callbacks,i=0,a=d.length;i<a;i++)d[i]();for(g=[];this._pending_callbacks.length;)f=this._pending_callbacks.pop(),t=f[0],_=f[1],this.is_ready()?g.push(t()):g.push("function"==typeof _?_(s.UNEXPECTED_ERROR):void 0);return g}if(e!==c._CONNECTION_RETRYING){if(e===c._CONNECTION_CLOSED){if(h===c._CONNECTION_PENDING)for(this.logger.report_event("connection_not_established"),p=this._on_open_failed_callbacks,r=0,u=p.length;r<u;r++)p[r]();else if(h===c._CONNECTION_RETRYING)for(this.logger.report_event("connection_terminated"),E=this._on_close_callbacks,o=0,l=E.length;o<l;o++)E[o]();else n.assert(!1,"CONNECTION_CLOSED can only be set from PENDING or RETRYING");for(O=[];this._pending_callbacks.length;)N=this._pending_callbacks.pop(),N[0],_=N[1],O.push("function"==typeof _?_(s.CONNECTION_CLOSED):void 0);return O}return n.assert(!1,"Changing connection_state to CONNECTION_PENDING not supported.")}}},c.prototype._on_message=function(e){return(function(n){return function(t){var _,i,s,r,o,a;return i=JSON.parse(t.data),null==i.func||null==(null!=(s=i.header)?s.message_id:void 0)||null==(null!=(r=i.header)?r.should_respond:void 0)?void n._terminate_handshake(e.ws,"Malformed message from client.",{message:t.data}):(null!=(null!=(o=i.header)?o.log_data:void 0)&&n.logger.update(i.header.log_data),n.logger.update({port:e.port}),"response"===i.func?n._on_response(i.header.message_id,i.data):(_=n._routes[i.func],null==_?void n._terminate_handshake(e.ws,"Unknown function.",{function:i.func}):(a=n.is_ready()?_(i.data):_(e,i.data),i.header.should_respond?n.send("response",a,null,null,i.header.message_id):void 0)))}})(this)},c.prototype.send=function(e,n,t,_,i){return null==n&&(n=null),null==t&&(t=null),null==_&&(_=null),null==i&&(i=null),this._send_with_ws(this._ws,e,n,t,_,i)},c.prototype._send_with_ws=function(e,t,_,i,r,o){var a,u,l;null==_&&(_=null),null==i&&(i=null),null==r&&(r=null),null==o&&(o=null),null==o&&(o=this._current_message_id,n.assert(this._current_message_id%2===1,"Web-initiated message_ids should remain odd"),this._current_message_id+=2),null!==i&&(l=window.setTimeout(this._on_response_timeout(o),c._RESPONSE_TIMEOUT),this._response_callbacks[o]=[i,r,l]),u={func:t,header:{message_id:o,should_respond:null!==i,log_data:this.logger.get_log_data_for_client()}},null!=_&&(u.data=_);try{return e.send(JSON.stringify(u))}catch(e){return a=e,this.logger.report_event("unity_failure",{message:"WebSocket send failed. Message: "+a.message,error_name:a.name}),"function"==typeof r?r(s.COULD_NOT_SEND):void 0}},c.prototype._on_response=function(e,n){var t,_,i;if(e in this._response_callbacks)return t=this._response_callbacks[e],_=t[0],t[1],i=t[2],delete this._response_callbacks[e],window.clearTimeout(i),_(n)},c.prototype._on_response_timeout=function(e){return(function(n){return function(){var t,_;return _=n._response_callbacks[e],_[0],t=_[1],_[2],delete n._response_callbacks[e],"function"==typeof t?t(s.CONNECTION_TIMEOUT):void 0}})(this)},c.prototype._check_unity_version=function(e,n){var t;return e.state!==c._CONNECTION_OPENED_STATE?void this._terminate_handshake(e.ws,"Handshake version check at wrong time of protocol."):(e.state=c._VERSION_CHECK_STATE,e.client_version=n.client_version,n.client_version<o.UNITY_HANDSHAKE?void this._terminate_handshake(e.ws,"Client version is too old."):(t=u.get_viewer().is_signed_in,n.client_version<o.PERMISSION_LEVELS&&!t?void this._terminate_handshake(e.ws,"Client version is too old to support insecure web connections."):(this.logger.report_event("handshake_version_check"),n.client_version>=o.PERMISSION_LEVELS?this._send_with_ws(e.ws,"initiate_handshake",{secure_web:t}):this._send_with_ws(e.ws,"initiate_handshake"))))},c.prototype._fetch_unity_nonce=function(e,n){return e.state===c._VERSION_CHECK_STATE?(e.state=c._FETCHING_NONCE_STATE,this.logger.report_event("handshake_fetch_nonce"),this._retrieve_unity_nonce(e,n.nonce_key)):this._terminate_handshake(e.ws,"Fetch Unity nonce at wrong time of protocol.")},c.prototype._retrieve_unity_nonce=function(e,i){return _.WebRequest({url:t({path:"/retrieve_unity_nonce"}),dataType:"json",data:{nonce_key:i},success:(function(t){return function(_){var i;switch(_.status){case"OK":return e.state=c._NONCE_RETURNED_TO_CLIENT_STATE,e.client_version>=o.PORT_CHECK&&(n.assert(_.message.client_port,"Port check must happen in version "+e.client_version),_.message.client_port!==e.port)?void t._terminate_handshake(e.ws,"Mismatched ports.",{client_port:_.message.client_port,web_port:e.port}):(e.client_has_auth=_.message.client_has_auth,i=u.get_viewer().is_signed_in,e.client_has_auth&&i?t._permission_level=c.SECURE_PERMISSION:(n.assert(e.client_version>=o.PERMISSION_LEVELS,"Insecure connections only supported by client_version >= "+o.PERMISSION_LEVELS+"."),t._permission_level=e.client_has_auth?c.INSECURE_WEB_PERMISSION:i?c.INSECURE_CLIENT_PERMISSION:c.INSECURE_PERMISSION),t.logger.update({unity_permission_level:t._permission_level}),t.logger.report_event("handshake_nonce_sent_to_unity_server"),t._send_with_ws(e.ws,"verify_unity_nonce",{nonce:_.message.nonce}));case"MISMATCHED_USER_IDS":return t._terminate_handshake(e.ws,"Mismatched user_ids.",{client_user_ids:_.message.client_user_ids,web_user_ids:_.message.web_user_ids});case"INVALID":return t._terminate_handshake(e.ws,"Could not find nonce with given nonce_key.");case"AUTH_REQUIRED":return t._terminate_handshake(e.ws,"Did not have the necessary authentication to retrieve nonce.");case"LOCAL_INFORMATION_PERMISSION_REQUIRED":return t._terminate_handshake(e.ws,"Did not have permission to start a local-information-allowed connection.")}}})(this),error:(function(n){return function(t,_,i){return n._terminate_handshake(e.ws,"Unable to retrieve nonce from server",{status:_,error_string:i})}})(this)})},c.prototype._complete_handshake=function(e,n){var t;return e.state===c._NONCE_RETURNED_TO_CLIENT_STATE&&n.is_success?(e.state=c._HANDSHAKE_COMPLETED_STATE,this._connection_state===c._CONNECTION_CLOSED?this._terminate_handshake(e.ws,"No more handshakes are allowed to complete."):null!=this._ws?(t="Only one Unity handshake can succeed! There's likely a MITM attack, so close all connections.",this._terminate_handshake(e.ws,t),this._terminate_handshake(this._ws,t),this.client_version=null,this._ws=null,this._port=null,this._set_connection_state(c._CONNECTION_CLOSED)):(this.client_version=e.client_version,this._ws=e.ws,this._port=e.port,this._set_connection_state(c._CONNECTION_ESTABLISHED))):this._terminate_handshake(e.ws,"Unable to complete handshake.")},c.prototype._terminate_handshake=function(n,t,_){var s;if(null==_&&(_=null),s={message:t},null!=_&&e.extend(s,_),i.getGandalfRule("unity-web-debug")&&console.error(s),this.logger.report_event("unity_failure",s),n)return n.close()},c.prototype._is_connection_in_progress=function(e){return e===c._CONNECTION_PENDING||e===c._CONNECTION_RETRYING},c.prototype.add_on_open_callback=function(e){return this._on_open_callbacks.push(e)},c.prototype.add_on_open_failed_callback=function(e){return this._on_open_failed_callbacks.push(e)},c.prototype.add_on_close_callback=function(e){return this._on_close_callbacks.push(e)},c.prototype.call_when_ready=function(e,n){return null==n&&(n=null),this.is_ready()?e():this._is_connection_in_progress(this._connection_state)?this._pending_callbacks.push([e,n]):"function"==typeof n?n(s.CONNECTION_CLOSED):void 0},c.prototype.is_ready=function(){var e;return(null!=(e=this._ws)?e.readyState:void 0)===WebSocket.OPEN&&this._connection_state===c._CONNECTION_ESTABLISHED},c.prototype.feature_supported=function(e,t){var _;return n.assert(null!==this._permission_level,"Connection is not ready."),!(this.client_version<e)&&(_=this._permission_level,indexOf.call(t,_)>=0)},c})()}),define("modules/clean/unity/connection_error",[],function(){return(function(){function e(){}return e.CONNECTION_TIMEOUT="connection_timeout",e.CONNECTION_CLOSED="connection_closed",e.COULD_NOT_SEND="could_not_send",e.UNEXPECTED_ERROR="unexpected_error",e})()}),define("modules/clean/unity/features",["jquery","modules/clean/ajax","modules/clean/filepath","modules/clean/unity/connection","modules/clean/unity/versions","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,n,t,_,i,s,r,o,a){if(null!=_)return(function(){function u(){}return u._uc=new _,u._has_handshake_started=!1,u._start_handshake_if_needed=function(){if(!this._has_handshake_started)return this._uc.start(),this._has_handshake_started=!0},u._cached_file_browser_display_name=null,u.continue_as_user=function(e,n,t,s){return null==s&&(s=null),this._start_handshake_if_needed(),this._uc.call_when_ready((function(r){return function(){if(r._uc.feature_supported(i.WEB_DESTINY,[_.INSECURE_WEB_PERMISSION]))return r._uc.logger.report_event("continue_as_user",{browser:e,refresh_token:n}),r._uc.send("continue_as_user",{browser:e,refresh_token:n},t,s)}})(this),s)},u.continue_as_user_direct=function(e,n){return null==n&&(n=null),this._start_handshake_if_needed(),this._uc.call_when_ready((function(t){return function(){if(t._uc.feature_supported(i.WEB_DESTINY_V2,[_.INSECURE_WEB_PERMISSION]))return t._uc.logger.report_event("continue_as_user_direct"),t._uc.send("continue_as_user_direct",null,e,n)}})(this),n)},u.web_destiny_info=function(e,n){return null==n&&(n=null),this._start_handshake_if_needed(),this._uc.call_when_ready((function(t){return function(){if(t._uc.feature_supported(i.WEB_DESTINY_V2,[_.INSECURE_WEB_PERMISSION]))return t._uc.logger.report_event("web_destiny_info"),t._uc.send("web_destiny_info",null,e,n)}})(this),n)},u.client_supports_open_in_file_browser=function(){return this._uc.feature_supported(i.OPEN_IN_FILE_BROWSER,[_.SECURE_PERMISSION])},u.open_file=function(e,r,o,u,c,l){var h;return null==c&&(c=null),null==l&&(l=!1),this._start_handshake_if_needed(),h=this.server_path(e,r),this._uc.call_when_ready((function(e){return function(){var r;if(e._uc.feature_supported(i.UNITY_HANDSHAKE,[_.SECURE_PERMISSION]))return e._uc.logger.report_event("open_file",{user_id:o,path_id:h,file_extension:t.file_extension(h),in_file_browser:l}),n.SilentBackgroundRequest({url:a({path:"/unity_open_log"}),data:{user_id:o,server_path:h,file_extension:t.file_extension(h),in_file_browser:l,unity_session_id:e._uc.logger.unity_session_id(),buildno:e._uc.logger._data.buildno,host_id:e._uc.logger._data.host_id}}),r={server_path:h,user_id:o},e._uc.client_version>=i.OPEN_IN_FILE_BROWSER?r.in_file_browser=l:s.assert(!l,"The connected client doesn't support opening in file browser."),e._uc.send("open_file",r,u,c)}})(this),c)},u.standard_open_file_handler=function(e){if(!e)return o.error(r._("Error opening file"))},u.check_file=function(e,n,s,r,o){var a,u;return null==o&&(o=null),this._start_handshake_if_needed(),u=this.server_path(e,n),a=(function(e){return function(n){return e._check_file_deprecated_on_client()&&(n={is_locally_available:n}),r(n)}})(this),this._uc.call_when_ready((function(e){return function(){if(e._uc.feature_supported(i.UNITY_HANDSHAKE,[_.SECURE_PERMISSION]))return e._uc.logger.report_event("check_file",{user_id:s,path_id:u,file_extension:t.file_extension(u)}),e._uc.send("check_file",{server_path:u,user_id:s},a,o)}})(this),o)},u.add_on_ready_callback=function(e){return this._uc.call_when_ready(e)},u.check_file_batch=function(n,s,r,o){var a,u,c,l,h;return null==o&&(o=null),a=e.Deferred(),this._start_handshake_if_needed(),h=function(){var e,t,_;for(_=[],e=0,t=n.length;e<t;e++)c=n[e],_.push(this.server_path(c.ns_id,c.ns_path));return _}.call(this),l=(function(e){return function(n){var t,_;if(e._check_file_deprecated_on_client())for(t in n)_=n[t],n[t]={is_locally_available:_};return"function"==typeof r&&r(n),a.resolve(n)}})(this),u=function(e){return"function"==typeof o&&o(e),a.reject(e)},this._uc.call_when_ready((function(e){return function(){var n;if(e._uc.feature_supported(i.UNITY_HANDSHAKE,[_.SECURE_PERMISSION]))return e._uc.logger.report_event("check_file_batch",{user_id:s,path_ids:h,file_extensions:(function(){var e,_,i;for(i=[],e=0,_=h.length;e<_;e++)n=h[e],i.push(t.file_extension(n));return i})()}),e._uc.send("check_file_batch",{server_paths:h,user_id:s},l,u)}})(this),u),a.promise()},u.file_browser_display_name=function(e,n){var t,s;return null==n&&(n=null),null!=this._cached_file_browser_display_name?void e(this._cached_file_browser_display_name):(t=(function(n){return function(t){return n._cached_file_browser_display_name=t,e(t)}})(this),this._start_handshake_if_needed(),s=(function(s){return function(){return s._uc.feature_supported(i.CHECK_FILE_RETURNS_OBJ,[_.SECURE_PERMISSION])?(s._uc.logger.report_event("file_browser_display_name"),s._uc.send("file_browser_display_name",null,t,n)):e(null)}})(this),this._uc.call_when_ready(s,n))},u._check_file_deprecated_on_client=function(){return i.UNITY_HANDSHAKE<=this._uc.client_version&&this._uc.client_version<i.CHECK_FILE_RETURNS_OBJ},u.server_path=function(e,n){return e+":"+n},u.has_chime=function(e,n){var t;return null==n&&(n=null),this._start_handshake_if_needed(),t=(function(t){return function(){if(t._uc.feature_supported(i.CHIME_OPEN,[_.SECURE_PERMISSION]))return t._uc.logger.report_event("has_chime"),t._uc.send("has_chime",null,e,n)}})(this),this._uc.call_when_ready(t,n)},u.open_chime=function(e,n,t){var s;return null==t&&(t=null),this._start_handshake_if_needed(),s=(function(s){return function(){if(s._uc.feature_supported(i.CHIME_OPEN,[_.SECURE_PERMISSION]))return s._uc.logger.report_event("open_chime",{parameters:e}),s._uc.send("open_chime",e,n,t)}})(this),this._uc.call_when_ready(s,t)},u})()}),define("modules/clean/unity/flash_config",["modules/clean/gandalf_util","modules/clean/unity/websocket_config","modules/constants/static"],function(e,n,t){if(window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0,window.DefaultWebSocket=window.WebSocket,n.useFlashShim()&&(window.WEB_SOCKET_FORCE_FLASH=!0),window.WEB_SOCKET_SWF_LOCATION=t.static_url_web_socket_swf,!e.getGandalfRule("unity-web-debug"))return window.WEB_SOCKET_LOGGER={log:function(){},error:function(){}}}),define("modules/clean/unity/logger",["jquery","modules/core/uri","modules/clean/ajax","modules/clean/gandalf_util","modules/clean/unity/versions"],function(e,n,t,_,i){return(function(){function s(){this._data={logging_source:"web",web_unity_version:i.LATEST}}return s.prototype.update=function(n){return e.extend(this._data,n)},s.prototype.report_event=function(e,i){if(null==i&&(i=null),this._data.event_name=e,this._data.local_ts=(new Date).getTime()/1e3,this._data.extra=JSON.stringify(i||{}),t.SilentBackgroundRequest({url:n({path:"/unity_connection_log"}),data:this._data}),_.getGandalfRule("unity-web-debug"))return console.log(this._data)},s.prototype.get_log_data_for_client=function(){return{web_unity_version:this._data.web_unity_version,user_agent:window.navigator.userAgent}},s.prototype.unity_session_id=function(){return this._data.unity_session_id},s})()}),define("modules/clean/unity/versions",function(){return(function(){function e(){}return e.LATEST=10,e.INITIAL_UNITY=1,e.UNITY_HANDSHAKE=2,e.REUNITY=3,e.OPEN_IN_FILE_BROWSER=4,e.CHECK_FILE_RETURNS_OBJ=5,e.PERMISSION_LEVELS=6,e.WEB_DESTINY=7,e.WEB_DESTINY_V2=8,e.PORT_CHECK=9,e.CHIME_OPEN=10,e})()}),define("modules/clean/unity/web_socket",["modules/constants/page_load","modules/clean/unity/logger","modules/clean/unity/websocket_config","external/web_socket"],function(e,n,t,_){var i;return i=17603,(function(){function e(){}return e.create=function(e){return"function"==typeof _.__initialize&&_.__initialize(),new _(e)},e.load_flash_policy_if_needed=function(){var e;if(e=new n,null!=(null!=_?_.loadFlashPolicyFile:void 0))e.report_event("load_flash_policy_file"),_.loadFlashPolicyFile("xmlsocket://127.0.0.1:"+i);else{if(t.useFlashShim())return e.report_event("unity_failure",{message:"Could not use WebSockets."}),!1;e.report_event("using_default_web_socket")}return!0},e.web_sockets_supported=function(){return null!=_},e})()}),define("modules/clean/unity/websocket_config",["external/flash_detect","modules/constants/unity","modules/core/browser"],function(e,n,t){return(function(){function _(){}return _.useFlashShim=function(){var _;return!n.FORCE_NATIVE_WEBSOCKET&&(!!e.versionAtLeast(10,3)&&(_=parseInt(t.version,10),!(t.safari&&_<9)&&!(t.chrome&&_>=53)))},_})()});
//# sourceMappingURL=pkg-maestro-unity.min.js-vfl01qWQF.map