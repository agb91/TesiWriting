var bind=function(t,n){return function(){return t.apply(n,arguments)}};define(["external/underscore","modules/constants/comments_panel","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/store","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store"],function(t,n,e,o,i,a,r,s,c,l,h){var u,v,d,p,assert,A,C;return assert=o.assert,v=i.Annotation,p=c.KeyCode,d=h.FileViewerStore,u=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui","mouse-up"],C=function(t){return t=t.replace(/(\-\w)/g,function(t){return t[1].toUpperCase()}),t.slice(0,1).toUpperCase()+t.slice(1)},A=n.ALLOW_ANNOTATION_GHOST,(function(){function n(t){this.prevState=t.prevState,this.state=t.state,this.interfaceController=t.interfaceController,this.actionCreators=t.actionCreators,this.onResetFileFeedbackUi=bind(this.onResetFileFeedbackUi,this),this.onMouseUp=bind(this.onMouseUp,this),this.onOnKeydown=bind(this.onOnKeydown,this),this.onScroll=bind(this.onScroll,this),this.onScaleChange=bind(this.onScaleChange,this),this.onAnnotationUiLeave=bind(this.onAnnotationUiLeave,this),this.onAnnotationUiEnter=bind(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=bind(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=bind(this.onAnnotationEndDrag,this),this.onAnnotationStartDrag=bind(this.onAnnotationStartDrag,this),this.onAnnotationPlaced=bind(this.onAnnotationPlaced,this),this.onAnnotationHidden=bind(this.onAnnotationHidden,this),this.onStateChange=bind(this.onStateChange,this)}return n.create=function(t){return new n({prevState:{activityKeys:[],hasEphemeral:!1},state:{ephemeralAnnotation:null,commentActivityByKey:{},canAnnotate:!1,regionCreationEnabled:!1,viewingAnnotationConversation:!1},interfaceController:null,actionCreators:t})},n.prototype.setState=function(n){return t.extend(this.state,n),this.performUpdateIfNecessary()},n.prototype.getStateFromStores=function(){var n,e,o,i,r;return r=a.state.showResolvedComments,e=!1,n=s.shouldShowExistingAnnotations()?a.state.activity.comment_activities.filter(function(t){var n;return(!t.comment.resolved||!e)&&null!=(null!=(n=t.comment.comment_metadata)?n.annotation:void 0)}):{},{activityKey:null!=(o=a.state.activity)?o.activity_key:void 0,actorId:a.state.actorId,activityContext:a.state.viewing.context,revision:a.state.viewing.revision,commentActivityByKey:t.indexBy(n,"activity_key"),ephemeralAnnotation:null!=(i=a.state.createAnnotation)?i.annotation:void 0,canAnnotate:s.canAnnotate(),regionCreationEnabled:s.isRegionCreationEnabled(),showResolved:r,viewingAnnotationConversation:null!=a.state.viewAnnotation}},n.prototype.onStateChange=function(){if(null!=a.state.activity)return this.setState(this.getStateFromStores())},n.prototype.mount=function(t){return assert(null!=t,"Interface controller must not be null"),assert(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(a.state),this.unsubscribeStore=a.listen(this.onStateChange),this.unsubscribeFileViewerStore=d.instance.addListener(this.onStateChange),this.addAnnotationEventListeners(),this.performUpdateIfNecessary()},n.prototype.unmount=function(){return assert(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},n.prototype.isMounted=function(){return null!=this.interfaceController},n.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},n.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},n.prototype.enableRegionCreation=function(){return this.interfaceController.dispatchEvent("enable-region-creation")},n.prototype.disableRegionCreation=function(){return this.interfaceController.dispatchEvent("disable-region-creation")},n.prototype.addAnnotationEventListeners=function(){return u.forEach((function(t){return function(n){var e,o;if(o="on"+C(n),e=t[o],null!=e)return t.interfaceController.on(n,e)}})(this))},n.prototype.removeAnnotationEventListeners=function(){return u.forEach((function(t){return function(n){var e,o;if(o="on"+C(n),e=t[o],null!=e)return t.interfaceController.off(n,e)}})(this))},n.prototype.onAnnotationHidden=function(t){return this.actionCreators.stopAnnotationCreation()},n.prototype.onAnnotationPlaced=function(t){var n;return n=v.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),l.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationStartDrag=function(t){return this.actionCreators.hideAnnotationConversation(),this.actionCreators.hideAnnotationInput()},n.prototype.onAnnotationEndDrag=function(t){var n;return this.actionCreators.hideAnnotationConversation(),n=v.createAnnotationFromDict(t.annotation),this.actionCreators.startAnnotationCreation({annotation:n}),l.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},n.prototype.onAnnotationUiClick=function(t){var n,o;return n=t.commentActivity.activity_key,this.actionCreators.revealAnnotationInPreview(n),this.actionCreators.revealCommentInPane({activityKey:n,expandConversation:!1}),l.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(o=t.commentActivity)?o.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiEnter=function(t){var n,o;if(null==this.state.ephemeralAnnotation&&(null==(n=a.state.viewAnnotation)||!n.replyFocused))return this.actionCreators.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:v.createAnnotationFromDict(t.annotation)}),l.log_annotation_event(e.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(o=t.commentActivity)?o.activity_key:void 0,this.state.actorId,this.state.activityContext)},n.prototype.onAnnotationUiLeave=function(t){var n,e;if(this.actionCreators.updateAnnotationUiHover(!1),null==this.state.ephemeralAnnotation&&(null==(e=a.state.viewAnnotation)||!e.replyFocused))return n=(function(t){return function(){var n,e;if(t.isMounted()&&!(null!=(n=a.state.viewAnnotation)?n.conversationHover:void 0)&&!(null!=(e=a.state.viewAnnotation)?e.annotationHover:void 0))return t.actionCreators.hideAnnotationConversation()}})(this),window.setTimeout(n,50)},n.prototype.onScaleChange=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},n.prototype.onScroll=function(n){var e;return this.actionCreators.hideAnnotationInput(),this.actionCreators.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),e=t.partial((function(t){return function(n){var e;return null!=(null!=n?n.annotation:void 0)?(e=v.createAnnotationFromDict(n.annotation),t.actionCreators.startAnnotationCreation({annotation:e})):t.actionCreators.showAnnotationInput()}})(this),n),this.annotationBubbleTimer=window.setTimeout(e,150)},n.prototype.onOnKeydown=function(t){if(s.normalizedKeyCode.apply(t)===p.ESC)return this.actionCreators.stopAnnotationCreation()},n.prototype.onMouseUp=function(t){if(null!=this.state.viewingAnnotationConversation)return this.actionCreators.hideAnnotationConversation()},n.prototype.onResetFileFeedbackUi=function(t){return this.actionCreators.stopAnnotationCreation(),this.actionCreators.hideAnnotationConversation()},n.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate,regionCreationEnabled:this.state.regionCreationEnabled,viewingAnnotationConversation:this.state.viewingAnnotationConversation}},n.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},n.prototype._updateAnnotations=function(t){var n,e,o,i,a,s,c,l,h,u;for(o=[],e=0,a=0,l=t.length;a<l;a++)i=t[a],i.comment.hasMetadata()&&i.comment.comment_metadata.hasAnnotationData()&&(e+=1,!this.state.showResolved&&i.comment.resolved||(h=i.comment.comment_metadata,n=h.annotation,u=h.revision,s=r.isRevisionEqual(this.state.revision,u),(A||null!=u&&s)&&(c=A&&null!=u&&!s,o.push({annotation:n,commentActivity:i,options:{isGhostAnnotation:c,isAnnotationNumberingEnabled:!0,annotationNumber:e}}))));return this.interfaceController.dispatchEvent("update-annotations",{annotations:o})},n.prototype.performUpdateIfNecessary=function(){var n,e;if(this.isMounted())return t.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(n=t.difference(null!=(e=this.prevState.activityKeys)?e:[],Object.keys(this.state.commentActivityByKey)),n.forEach(this._removeAnnotation,this),this._updateAnnotations(t.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),this.prevState.regionCreationEnabled!==this.state.regionCreationEnabled&&(this.state.regionCreationEnabled?this.enableRegionCreation():this.disableRegionCreation()),this.prevState.viewingAnnotationConversation!==this.state.viewingAnnotationConversation&&(this.state.viewingAnnotationConversation?this.disableRegionCreation():this.state.regionCreationEnabled&&this.enableRegionCreation()),this._savePrevState()},n})()});
//# sourceMappingURL=file_preview_annotations.min.js-vflrq0GrS.map